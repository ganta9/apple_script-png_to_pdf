# ImageMagickによる横向きPDF実装 完全ガイド

## 目的
横向きPDF作成における試行錯誤の完全記録。失敗から学んだ知見と最終的な成功事例をまとめ、今後のPDF開発の参考資料とする。

## 要件の明確化
- **ユーザーの期待**: PDFビューアで開いた時に「ページ自体が横向き」になっている
- **避けるべき状態**: 縦ページ内で画像が90度傾いている状態

## 失敗事例一覧

### 失敗パターン1: `-rotate 90`使用
```bash
convert -rotate 90 -page A4 input.png output.pdf
```
**結果**: 縦ページ内で画像が90度回転して横倒し
**問題**: ページサイズは縦のまま、画像だけが回転

### 失敗パターン2: カスタムページサイズ指定
```bash
convert -page 297x210mm input.png output.pdf
```
**結果**: 真っ黒なPDFページ
**問題**: `-page`だけでは画像の配置・スケーリングが正しく動作しない

### 失敗パターン3: 複雑なgeometry指定（低解像度）
```bash
convert -resize 842x595 -background white -gravity center -extent 842x595 input.png output.pdf
```
**結果**: 横向きページは作成されるが解像度が悪い
**問題**: 72DPI相当の低解像度

### 失敗パターン4: 高解像度geometry指定
```bash
convert -density 300 -resize 3508x2480> -background white -gravity center -extent 3508x2480 input.png output.pdf
```
**結果**: PDF作成に失敗
**問題**: パラメータが複雑すぎてImageMagickが処理できない

### 失敗パターン5: `-auto-orient`使用
```bash
convert -page A4 -auto-orient input.png output.pdf
```
**結果**: 効果なし、通常の縦ページ
**問題**: `-auto-orient`は既存のEXIF情報に基づく回転のみ

### 失敗パターン6: 2段階プロセス（ImageMagick→sips）
```applescript
-- Stage 1: ImageMagickで縦向きPDF作成
set convertCmd to convertCmd & " -quality " & imageQuality & " -compress jpeg " & batchFilesStr & " " & quoted form of tempVerticalPdf
-- Stage 2: sipsでPDFページを90度回転
set sipsCmd to "sips --rotate 90 " & quoted form of tempVerticalPdf & " --out " & quoted form of tempPdfPath
```
**結果**: 1ページ目のみPDF化、解像度低下、ただしページは横向き
**問題**: 
- `sips`は複数ページPDFに対して1ページ目のみ処理
- 回転処理で解像度が劣化
- バッチ処理（複数PNG→PDF）が機能しない

### 失敗パターン7: `-extent`による強制横向き作成
```bash
convert -page A4 -rotate 90 -gravity center -extent 842x595 -quality 85 -compress jpeg input.png output.pdf
```
**結果**: 縦ページに90度傾いた画像、画像が拡大され見切れ
**問題**:
- ページサイズは縦のまま（A4 = 595x842）
- `-rotate 90`は画像のみ回転、ページは回転しない
- `-extent 842x595`で画像が強制拡大され見切れる
- 根本的に「画像回転」と「ページ向き」は別の概念

### 失敗パターン8: 直接横向きページサイズ指定
```bash
convert -page 842x595 -gravity center -quality 85 -compress jpeg input.png output.pdf
```
**結果**: 正しい横向きページだが白紙（画像なし）
**問題**:
- ページは正しく横向きになる
- しかし画像が表示されない（白紙ページ）
- `-page`サイズ指定だけでは画像の配置・スケーリングが不適切
- ImageMagickの仕様上、カスタムページサイズ時は追加の画像処理が必要

## 根本的な問題の分析

### ImageMagickの制限
1. **`-page`**: ページサイズを指定するが、向きは変更しない
2. **`-rotate`**: 画像を回転するが、ページサイズは変更しない
3. **カスタムサイズ**: `297x210mm`等の指定は配置が困難

### 技術的課題
- ImageMagickだけでは「PDFページ自体の向き」を変更するのは困難
- 横向きPDFを作るには外部ツール（pdftk等）との組み合わせが必要
- または、根本的に異なるアプローチが必要

## 今後の対策

### 避けるべきアプローチ
1. ❌ `-rotate 90`の使用（画像が傾く）
2. ❌ カスタムページサイズのみの指定（真っ黒になる）
3. ❌ 複雑すぎるgeometry指定（作成失敗）
4. ❌ `-auto-orient`への期待（効果なし）
5. ❌ **2段階プロセス（ImageMagick→sips）**（1ページのみ、解像度低下）
6. ❌ **`-extent`強制拡大アプローチ**（画像見切れ、縦ページのまま）
7. ❌ **直接横向きページサイズ指定**（白紙ページ）

### 推奨アプローチ
1. ✅ **現実的な妥協案**: 横向きオプションを削除し、縦向きのみサポート
2. ✅ **外部ツール使用**: ImageMagick + pdftk の組み合わせ
3. ✅ **代替ライブラリ**: Python PyPDF2/PyPDF4 等の使用
4. ✅ **ユーザー説明**: 横向きは技術的制約により縦ページ内回転となる旨を明示

## 今後の実装指針

### 優先順位
1. **確実性重視**: まず動作する実装を作る
2. **段階的改善**: 基本機能完成後に横向き対応を検討
3. **ユーザー期待管理**: 制約事項を事前に説明

### チェックリスト
- [ ] 縦向きPDFは確実に動作するか？
- [ ] 横向き実装前に失敗事例を確認したか？
- [ ] 新しいアプローチを試す前に、なぜ既存の方法が失敗したかを理解したか？
- [ ] 複雑な実装より、シンプルで確実な実装を選択したか？

## 結論
現在の技術的制約下では、ImageMagickのみで理想的な横向きPDFを作成するのは困難。
- **短期的解決策**: 縦向きのみサポート、または横向きの制約を明示
- **長期的解決策**: 外部ツールとの組み合わせによる本格的な横向きPDF対応

## 成功事例：最終的な解決策

### 成功パターン: オフセット付きページサイズ指定
```bash
magick -page 842x595+0+0 -quality 85 -compress jpeg input.png output.pdf
```
**結果**: ✅ 完璧な横向きPDF
**成功要因**:
- **正確な横向きサイズ**: A4横向き = 842x595 (縦595x842の逆)
- **オフセット指定**: `+0+0` でページ内の画像配置を明示
- **シンプルな1段階処理**: 複雑な回転や変換を避けた直接的アプローチ

### 技術的知見まとめ

#### ImageMagickでのPDF作成の基本原則
1. **ページサイズ指定**: `-page WIDTHxHEIGHT+X+Y` が基本形
2. **横向きPDF**: 縦横を入れ替えた数値を指定（A4: 595x842 → 842x595）
3. **オフセット必須**: カスタムサイズ時は `+0+0` で位置を明示

#### 避けるべき間違ったアプローチ
- ❌ **画像回転**: `-rotate 90` はページではなく画像のみ回転
- ❌ **複雑なgeometry**: `-extent`, `-resize` の組み合わせは不安定
- ❌ **2段階処理**: ImageMagick→外部ツールは複雑で問題が多い
- ❌ **オフセット省略**: カスタムページサイズ時は白紙になる

## 新たな発見：sipsの制限

### sipsの技術的制限
- **複数ページPDF非対応**: 複数ページPDFに対して1ページ目のみ処理
- **解像度劣化**: 回転処理で画質が低下
- **バッチ処理の阻害**: 複数PNG→PDFのワークフローが破綻

### ImageMagickとPDFページサイズの関係
1. **標準サイズ**: `A4`, `A3`, `Letter` 等は自動で正しい向きに設定される
2. **カスタムサイズ**: 数値指定時はオフセット `+X+Y` が必須
3. **バッチ処理**: 複数画像を1つのPDFにする場合も同じルールが適用

### 最終判断の更新
横向きPDF作成は**完全に解決可能**：
- ✅ ページの向き：`842x595` で正しく横向き
- ✅ 複数ページ：バッチ処理対応
- ✅ 画質：劣化なし
- ✅ 実用性：シンプルで確実な1段階処理

**結論**: オフセット付きページサイズ指定により、ImageMagickのみで完璧な横向きPDF作成が可能

## 今後のPDF開発での推奨事項

### 🔥 重要な教訓
1. **PDFの向き = ページサイズの向き**: 画像回転ではなくページサイズで制御
2. **カスタムサイズ時はオフセット必須**: `+0+0` を忘れずに追加
3. **シンプルイズベスト**: 複雑な多段階処理より直接的アプローチ

### 📋 チェックリスト（今後のPDF実装時）
- [ ] ページサイズは正しく計算されているか？（横向き = 縦横入れ替え）
- [ ] カスタムサイズ時にオフセット `+0+0` を指定しているか？
- [ ] 画像回転（`-rotate`）に頼っていないか？
- [ ] バッチ処理で複数ページが正しく作成されるか？
- [ ] 1段階の直接的アプローチを採用しているか？

## バージョン履歴
- v1.0 (2025-06-29): 初版作成、v3.0-v4.0での失敗事例を記録
- v1.1 (2025-06-29): 2段階プロセス（ImageMagick→sips）の失敗事例を追加
- v2.0 (2025-06-29): **成功事例追加**、知見まとめ、今後の推奨事項を整理